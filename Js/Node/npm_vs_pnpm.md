# npm vs pnpm: Как Node.js подтягивает зависимости

---

## 1. Как работает npm (классический подход)

Когда ты запускаешь `npm install`, происходит следующее:

1. npm читает `package.json` и `package-lock.json`
2. Скачивает все пакеты из реестра (registry.npmjs.org)
3. **Копирует** каждый пакет в папку `node_modules`

### Проблема: Плоская структура (flat node_modules)

npm использует "hoisting" — поднимает зависимости на верхний уровень:

```
project/
└── node_modules/
    ├── react/           # твоя зависимость
    ├── lodash/          # зависимость react (поднята наверх)
    ├── some-util/       # зависимость lodash (тоже поднята)
    └── ...
```

### Проблемы этого подхода:

```
┌─────────────────────────────────┬──────────────────────────────────────────────────┐
│ Проблема                        │ Описание                                         │
├─────────────────────────────────┼──────────────────────────────────────────────────┤
│ Phantom dependencies            │ Можешь импортировать пакет, который не указан   │
│                                 │ в твоём package.json (он "случайно" есть в       │
│                                 │ node_modules как зависимость другого пакета)     │
├─────────────────────────────────┼──────────────────────────────────────────────────┤
│ Дублирование пакетов            │ Если разным пакетам нужны разные версии одной   │
│                                 │ библиотеки — они дублируются                     │
├─────────────────────────────────┼──────────────────────────────────────────────────┤
│ Огромный размер node_modules    │ Каждый проект хранит свою полную копию всех     │
│                                 │ зависимостей                                     │
├─────────────────────────────────┼──────────────────────────────────────────────────┤
│ Медленная установка             │ Каждый раз скачивает и копирует все файлы       │
└─────────────────────────────────┴──────────────────────────────────────────────────┘
```

---

## 2. Как работает pnpm (content-addressable storage)

pnpm использует принципиально другой подход:

1. **Глобальное хранилище**: Все пакеты хранятся в одном месте (`~/.pnpm-store`)
2. **Жёсткие ссылки (hard links)**: В `node_modules` создаются ссылки на файлы из хранилища
3. **Строгая структура**: Каждый пакет видит только свои зависимости

### Структура node_modules в pnpm:

```
project/
└── node_modules/
    ├── .pnpm/                          # Реальные файлы (hard links на store)
    │   ├── react@18.2.0/
    │   │   └── node_modules/
    │   │       ├── react/              # hard link → ~/.pnpm-store
    │   │       └── loose-envify/       # зависимость react
    │   └── lodash@4.17.21/
    │       └── node_modules/
    │           └── lodash/             # hard link → ~/.pnpm-store
    │
    ├── react -> .pnpm/react@18.2.0/node_modules/react    # symlink
    └── lodash -> .pnpm/lodash@4.17.21/node_modules/lodash # symlink
```

### Как это работает:

```
┌───────────────────────────────────────────────────────────────────────────────┐
│                              ~/.pnpm-store                                    │
│                    (глобальное хранилище всех пакетов)                        │
│                                                                               │
│   react@18.2.0   lodash@4.17.21   express@4.18.2   ...                       │
│        │               │                │                                     │
└────────┼───────────────┼────────────────┼─────────────────────────────────────┘
         │               │                │
    hard links      hard links       hard links
         │               │                │
         ▼               ▼                ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         project/node_modules/.pnpm                          │
│                                                                             │
│   react@18.2.0/      lodash@4.17.21/     (только нужные версии)            │
│        │                   │                                                │
└────────┼───────────────────┼────────────────────────────────────────────────┘
         │                   │
      symlinks           symlinks
         │                   │
         ▼                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         project/node_modules                                │
│                                                                             │
│   react/              lodash/           (то, что видит твой код)           │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 3. Сравнение npm и pnpm

```
┌────────────────────────────┬─────────────────────────────┬─────────────────────────────┐
│ Аспект                     │ npm                         │ pnpm                        │
├────────────────────────────┼─────────────────────────────┼─────────────────────────────┤
│ Хранение пакетов           │ Копии в каждом проекте      │ Один store + hard links     │
├────────────────────────────┼─────────────────────────────┼─────────────────────────────┤
│ Размер на диске            │ Большой (дублирование)      │ Маленький (переиспользует)  │
├────────────────────────────┼─────────────────────────────┼─────────────────────────────┤
│ Скорость установки         │ Медленная                   │ Быстрая (особенно повторно) │
├────────────────────────────┼─────────────────────────────┼─────────────────────────────┤
│ Phantom dependencies       │ Возможны                    │ Невозможны (строгая         │
│                            │                             │ изоляция)                   │
├────────────────────────────┼─────────────────────────────┼─────────────────────────────┤
│ Структура node_modules     │ Плоская (hoisting)          │ Вложенная (через .pnpm)     │
├────────────────────────────┼─────────────────────────────┼─────────────────────────────┤
│ Lock-файл                  │ package-lock.json           │ pnpm-lock.yaml              │
└────────────────────────────┴─────────────────────────────┴─────────────────────────────┘
```

---

## 4. Почему pnpm быстрее?

### При первой установке в новом проекте:
- **npm**: Скачивает → Распаковывает → Копирует в node_modules
- **pnpm**: Скачивает → Распаковывает в store → Создаёт hard links

### При повторной установке (пакет уже есть в store):
- **npm**: Проверяет кэш → Копирует из кэша в node_modules
- **pnpm**: Создаёт hard links (моментально, без копирования)

### Пример экономии места:

```
10 проектов с React + TypeScript + Webpack

npm:   ~1.5 GB (150 MB × 10 копий)
pnpm:  ~200 MB (один store + символические ссылки)
```

---

## 5. Hard links vs Symlinks

```
┌─────────────────────────┬──────────────────────────────────────────────────────┐
│ Тип ссылки              │ Что делает                                           │
├─────────────────────────┼──────────────────────────────────────────────────────┤
│ Hard link               │ Указывает на те же данные на диске. Файл не         │
│                         │ дублируется, но выглядит как обычный файл.          │
│                         │ pnpm использует для файлов внутри пакетов.          │
├─────────────────────────┼──────────────────────────────────────────────────────┤
│ Symlink (символическая) │ Указывает на путь к другому файлу/папке.            │
│                         │ pnpm использует для ссылок из node_modules          │
│                         │ на .pnpm папку.                                      │
└─────────────────────────┴──────────────────────────────────────────────────────┘
```

---

## Итого

1. **npm** копирует все зависимости в каждый проект → много места, медленно
2. **pnpm** хранит пакеты один раз в глобальном store и создаёт ссылки → быстро, экономит место
3. **pnpm** строже — защищает от phantom dependencies (нельзя случайно импортировать чужие зависимости)
4. Для Node.js всё выглядит одинаково — `require('react')` работает и там, и там

